<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحديث بطاقة العائلة 2025</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            direction: rtl;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 60%;
            margin: 20px auto;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        .logo {
            text-align: center;
            margin-bottom: 20px;
        }

        .logo img {
            max-width: 100px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
        }

        .input-group input, 
        .input-group file {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .upload-btn, 
        .add-file-btn {
            display: block;
            width: 100%;
            padding: 10px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .upload-btn:hover, 
        .add-file-btn:hover {
            background-color: #218838;
        }

        .success-message, 
        .error-message {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        .success-message {
            color: green;
        }

        .error-message {
            color: red;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="logo">
        <img src="logo.png" alt="Logo">
    </div>
    <div class="header">تحديث بطاقة العائلة 2025</div>

    <!-- Form to Retrieve Data -->
    <form id="retrieveForm">
        <div class="input-group">
            <label for="retrieveBoxNumber">رقم الصندوق</label>
            <input type="number" id="retrieveBoxNumber" required>
        </div>
        <div class="input-group">
            <label for="retrieveCivilId">رقم المدني</label>
            <input type="number" id="retrieveCivilId" required>
        </div>
        <button type="button" class="upload-btn" id="retrieveButton">جلب البيانات</button>
    </form>

    <!-- Form to Submit Data -->
    <form id="familyForm" enctype="multipart/form-data">
        <div class="input-group">
            <label for="name">الاسم</label>
            <input type="text" id="name" name="name" required>
        </div>
        <div class="input-group">
            <label for="boxNumber">رقم الصندوق</label>
            <input type="number" id="boxNumber" name="boxNumber" readonly>
        </div>
        <div class="input-group">
            <label for="civilId">رقم المدني</label>
            <input type="number" id="civilId" name="civilId" readonly>
        </div>
        <div class="input-group">
            <label for="phone1">رقم الموبايل 1</label>
            <input type="number" id="phone1" name="phone1" required>
        </div>
        <div class="input-group">
            <label for="phone2">رقم الموبايل 2 (اختياري)</label>
            <input type="number" id="phone2" name="phone2">
        </div>
        <div id="fileInputsContainer" class="input-group">
            <label>رفع المستندات</label>
            <input type="file" name="files" class="file-upload" required>
        </div>
        <button type="button" class="add-file-btn" id="addFileButton">إضافة مستند آخر</button>
        <div class="input-group">
            <label for="optionalEmail">البريد الإلكتروني (اختياري)</label>
            <input type="email" id="optionalEmail" name="optionalEmail">
        </div>
        <button type="submit" class="upload-btn" id="submitButton" disabled>إرسال</button>
        <div class="notes">
            <p>المستندات المطلوبة حسب الحالة الاجتماعية:</p>
            <ul>
                <li>البطاقة المدنية لحامل البطاقة والمرافقين من تطبيق هويتي.</li>
                <li>شهادة استمرارية زواج.</li>
                <li>شهادة طلاق.</li>
                <li>حكم حضانة.</li>
                <li>شهادة ميلاد.</li>
            </ul>
        </div>
        <div id="successMessage" class="success-message">تم إرسال البيانات بنجاح</div>
        <div id="errorMessage" class="error-message">حدث خطأ أثناء إرسال البيانات</div>
    </form>
</div>

<script>
    const retrieveButton = document.getElementById("retrieveButton");
    const submitButton = document.getElementById("submitButton");
    const addFileButton = document.getElementById("addFileButton");
    const fileInputsContainer = document.getElementById("fileInputsContainer");

    retrieveButton.addEventListener("click", function () {
        const boxNumber = document.getElementById("retrieveBoxNumber").value;
        const civilId = document.getElementById("retrieveCivilId").value;

        if (!boxNumber || !civilId) {
            alert("يرجى إدخال رقم الصندوق ورقم المدني.");
            return;
        }

        fetch('https://aa12-195-39-172-34.ngrok-free.app/api/get-shareholder?boxnumber=${boxNumber}&civilid=${civilId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById("name").value = data.data.name || '';
                    document.getElementById("boxNumber").value = data.data.boxnumber || '';
                    document.getElementById("civilId").value = data.data.civilid || '';
                    checkFormValidity();
                } else {
                    alert(data.message || "لم يتم العثور على البيانات.");
                }
            })
            .catch(() => alert("حدث خطأ أثناء جلب البيانات."));
    });

    addFileButton.addEventListener("click", function () {
        const input = document.createElement("input");
        input.type = "file";
        input.name = "files";
        input.classList.add("file-upload");
        fileInputsContainer.appendChild(input);
        checkFormValidity();
    });

    document.getElementById("familyForm").addEventListener("submit", function (event) {
        event.preventDefault();

        const formData = new FormData(this);

        fetch("https://aa12-195-39-172-34.ngrok-free.app/api/save-shareholder", {
            method: "POST",
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById("successMessage").style.display = "block";
                    document.getElementById("errorMessage").style.display = "none";
                    downloadFiles(data.files);
                } else {
                    document.getElementById("successMessage").style.display = "none";
                    document.getElementById("errorMessage").style.display = "block";
                }
            })
            .catch(() => {
                document.getElementById("successMessage").style.display = "none";
                document.getElementById("errorMessage").style.display = "block";
            });
    });

    function checkFormValidity() {
        const name = document.getElementById("name").value;
        const boxNumber = document.getElementById("boxNumber").value;
        const civilId = document.getElementById("civilId").value;
        const phone1 = document.getElementById("phone1").value;
        const files = document.querySelectorAll(".file-upload");

        const hasFiles = Array.from(files).some(input => input.files.length > 0);

        if (name && boxNumber && civilId && phone1 && hasFiles) {
            submitButton.disabled = false;
        } else {
            submitButton.disabled = true;
        }
    }

    function downloadFiles(files) {
        files.forEach(fileUrl => {
            const a = document.createElement("a");
            a.href = fileUrl;
            a.download = fileUrl.split("/").pop();
            a.click();
        });
    }

    document.getElementById("familyForm").addEventListener("input", checkFormValidity);
</script>

</body>
</html>
